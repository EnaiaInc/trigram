#!/usr/bin/env bash
set -euo pipefail

if ! command -v gh >/dev/null 2>&1; then
  echo "gh CLI is required" >&2
  exit 1
fi

if ! command -v mix >/dev/null 2>&1; then
  echo "mix is required" >&2
  exit 1
fi

cd "$(dirname "$0")/.."

version=$(rg -n "@version" mix.exs | sed -n 's/.*@version "\(.*\)".*/\1/p' | head -n 1)
if [[ -z "${version}" ]]; then
  echo "Unable to determine version from mix.exs" >&2
  exit 1
fi

tag="v${version}"
hex_args=("$@")

if [[ -n "$(git status --porcelain)" ]]; then
  echo "Working tree is dirty. Commit or stash changes first." >&2
  exit 1
fi

remote_tag=$(git ls-remote --tags origin "refs/tags/${tag}" | awk '{print $1}')

if [[ -z "${remote_tag}" ]]; then
  if ! git rev-parse "${tag}" >/dev/null 2>&1; then
    git tag "${tag}"
  fi

  git push origin "${tag}"
fi

echo "Waiting for release workflow to finish for ${tag}..."
run_id=""
run_status=""
run_conclusion=""
attempts=0
max_attempts=30
sleep_seconds=10

while [[ -z "${run_id}" && "${attempts}" -lt "${max_attempts}" ]]; do
  run_line=$(gh run list --repo EnaiaInc/trigram --limit 20 --json databaseId,displayTitle,headBranch,status,conclusion \
    | jq -r ".[] | select(.displayTitle == \"Release\" and .headBranch == \"${tag}\") | \"\\(.databaseId) \\(.status) \\(.conclusion)\"" \
    | head -n 1)

  if [[ -n "${run_line}" ]]; then
    run_id=$(echo "${run_line}" | awk '{print $1}')
    run_status=$(echo "${run_line}" | awk '{print $2}')
    run_conclusion=$(echo "${run_line}" | awk '{print $3}')
  fi

  if [[ -z "${run_id}" ]]; then
    attempts=$((attempts + 1))
    sleep "${sleep_seconds}"
  fi
done

if [[ -z "${run_id}" ]]; then
  echo "Release workflow not found for ${tag} after $((max_attempts * sleep_seconds))s." >&2
  exit 1
fi

if [[ "${run_status}" == "completed" && "${run_conclusion}" == "success" ]]; then
  echo "Release workflow already completed successfully for ${tag}."
else
  gh run watch "${run_id}" --repo EnaiaInc/trigram
fi

rm -f checksum-Elixir.Trigram.Native.exs

MIX_ENV=prod mix rustler_precompiled.download Trigram.Native --all --print --no-config

if [[ ! -f checksum-Elixir.Trigram.Native.exs ]]; then
  echo "Checksum file was not generated." >&2
  exit 1
fi

MIX_ENV=dev mix hex.publish "${hex_args[@]}"
